<?php
/**
* This module contains custom functionality for sites that I run.
* 
* @todo List specific features here. :-)
*
* @author Douglas Muth <http://www.claws-and-paws.com/>
*/


/**
* Our init hook.
*/
function ddt_init() {

	//
	// Various debugging statements for testing.
	//
	//print "In ddt_init()"; // Debugging
	//ddt_log("test: !time", array("!time" =>  time()));
	//ddt_log("test: !time", array("!time" =>  time()), WATCHDOG_WARNING);
	//ddt_log("test: !time", array("!time" =>  time()), WATCHDOG_ERROR, l("TEST", "http://test"));

} // End of ddt_init()


/**
* Log when this module is enabled.
*/
function ddt_enable() {
	ddt_log("DDT Module enabled");
}


/**
* Log when this module is disabled.
*/
function ddt_disable() {
	ddt_log("DDT Module disabled");
}


/**
* This function is called whenever a node is created, changed, etc.
*/
function ddt_nodeapi($node, $op) {

	//print_r($node); // Debugging

	//
	// We only care about changes to the post
	//
	if ($op != "delete" && $op != "delete revision"
		&& $op != "insert" && $op != "update") {
		return(null);
	}

	$message = t("Op: %op on NID %nid ")
		. "(" 
			. t("Topic: %topic, ")
			. t("Published?: %published, ")
			. t("Promoted?: %promoted, ")
			. t("Sticky?: %sticky, ")
			. t("Comments allowed?: %comments") . 
		")";
	$var = array();
	$var["%nid"] = $node->nid;
	$var["%op"] = $op;
	$var["%topic"] = $node->title;
	$var["%published"] = $node->status;
	$var["%promoted"] = $node->promote;
	$var["%sticky"] = $node->sticky;
	$var["%comments"] = $node->comment;
	$link = l("view", "node/" . $node->nid);

	ddt_log($message, $var, "", $link);

} // End of ddt_nodeapi()


/**
* Hook activity on comments.
*/
function ddt_comment($comment, $op) {

	//
	// We only care about changes to the comment
	//
	if ($op != "delete" && $op != "insert" && $op != "update"
		&& $op != "publish" && $op != "unpublish"
		) {
		return(null);
	}

	$nid = "";
	$message = t("Op: %op ");
	$var = array();
	$var["%op"] = $op;

	//
	// $comment can be an array or an object based on what our operation is.
	//
	if ($op == "insert") {
		$message .= t("on CID %cid");
		$var["%cid"] = $comment["cid"];
		$nid = $comment["nid"];

	} else if ($op == "update") {
		$message .= t("on CID %cid");
		$var["%cid"] = $comment["cid"];
		$nid = $comment["nid"];

		if ($comment["status"] == 1) {
			$message .= t(" (Probably unpublishing.");
		}

	} else if ($op == "delete") {
		$message .= t("on CID %cid");
		$var["%cid"] = $comment->cid;
		$nid = $comment->nid;

	} else if ($op == "publish") {
		$message .= t("on CID %cid");
		$var["%cid"] = $comment["cid"];
		$nid = $comment["nid"];

	} else {
		//
		// catch-all in case something unexpected comes along.
		//
		$message .= t("UNKNOWN OP");

	}

	//
	// If we have a CID, set a link.
	//
	$link = "";
	if (!empty($var["%cid"])) {
		$options = array();
		$options["fragment"] = "comment-" . $var["%cid"];
		$link = l("view", "node/" . $nid, $options);
	}

	ddt_log($message, $var, "", $link);

} // End of ddt_comment()

/*

Other things to hook:
	- block/unblock user
		- hook_user()
	- flag
	- enable/disable another module
	- send private message
	- Dump the variables table and compare during cron?
		- Where to store it?
		- cache_ddt table? :-)

*/



/**
* Our wrapper for watchdog()
*
* @param string $message The message, which will be passed to t().
*	For substitution, using !string is probably the way to go.
*
* @param array $variables Array of variable substituions for t().
*
* @param string $severity Valid values are WATCHDOG_NOTICE, 
*	WATCHDOG_WARNING, and WATCHDOG_ERROR.
*
* @return void
*
*/
function ddt_log($message, $variables = array(), 
	$severity = WATCHDOG_NOTICE, $url = "") {

	if ($severity == "") {
		$severity = WATCHDOG_NOTICE;
	}

	watchdog("ddt", $message, $variables, $severity, $url);

} // End of ddt_log()

